# Lefthook configuration for git hooks
# Install: bun run prepare (runs lefthook install)

pre-commit:
  parallel: true
  commands:
    # Lint: fail on errors AND warnings (zero-tolerance)
    lint:
      glob: "*.{ts,tsx}"
      run: bunx biome check src test scripts
      stage_fixed: true

    # Type check
    typecheck:
      glob: "*.{ts,tsx}"
      run: bunx tsc --noEmit
      stage_fixed: true

    # MCP schema compliance (fast, <1s) - catches discriminatedUnion regressions
    mcp-schema:
      glob: "*.{ts,tsx}"
      run: bun test test/mcp-schema.test.ts --bail --timeout 10000
      fail_text: "MCP schema validation failed. Tool schemas must have type='object' at root (no discriminatedUnion)."

    # Run tests with bail on first failure
    test:
      glob: "*.{ts,tsx}"
      run: bun test --bail --timeout 60000
      stage_fixed: true

pre-push:
  commands:
    coverage:
      run: bun run test:ci
      fail_text: "Coverage check failed. Ensure >85% line coverage on src modules (excludes src/tools/)"

commit-msg:
  commands:
    validate:
      run: |
        msg=$(cat {1})
        # Check for conventional commit format (optional but recommended)
        if ! echo "$msg" | grep -qE "^(feat|fix|docs|style|refactor|test|chore|ci|deps)(\(.+\))?: .+"; then
          echo "Warning: Consider using conventional commits format:"
          echo "  feat|fix|docs|style|refactor|test|chore|ci|deps(scope): message"
        fi
        # Enforce minimum length
        if [ ${#msg} -lt 10 ]; then
          echo "Error: Commit message too short (min 10 chars)"
          exit 1
        fi
